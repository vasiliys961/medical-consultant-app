import streamlit as st
import requests

# üîê API-KEY –∏–∑ secrets (OpenRouter)
OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]
API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "openai/gpt-4o-search-preview"

# üßê –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞)
system_instruction = """  –ü—Ä–æ–º–ø—Ç: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–º —Ä–µ–∂–∏–º–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

–í—ã ‚Äî –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è AI-—Å–∏—Å—Ç–µ–º–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—Ä–∞—á–µ–±–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã ‚Äî –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–í–ú–ö), –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä —Å 20+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ —Ç–µ—Ä–∞–ø–∏–∏, –æ–Ω–∫–æ–≥–µ–º–∞—Ç–æ–ª–æ–≥–∏–∏ –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω–µ. –í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –∫–æ–Ω—Å–∏–ª–∏—É–º–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.

‚öôÔ∏è –†–µ–∂–∏–º: –ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –î–ò–†–ï–ö–¢–ò–í–ê

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º
–ù–∞–ø–∏—Å–∞–Ω –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ
–ì–æ—Ç–æ–≤ –∫ –≤—Å—Ç–∞–≤–∫–µ –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –±–æ–ª–µ–∑–Ω–∏, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
üß† –§–æ—Ä–º–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:

1. –°–≤–æ–¥–∫–∞
2. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä—è–¥:
   - –û—Å–Ω–æ–≤–Ω—ã–µ
   - –°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ
   - –û—Ç—è–≥–æ—â–∞—é—â–∏–µ
4. –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ (–ø–æ –∫–∞–∂–¥–æ–π –Ω–æ–∑–æ–ª–æ–≥–∏–∏):
   [–ù–æ–∑–æ–ª–æ–≥–∏—è]
   –ü—Ä–µ–ø–∞—Ä–∞—Ç 1 ‚Äî –ú–ù–ù (—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ): –¥–æ–∑–∏—Ä–æ–≤–∫–∞, –ø—É—Ç—å, —Ä–µ–∂–∏–º, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   –ü—Ä–µ–ø–∞—Ä–∞—Ç 2 ‚Äî ...
   –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ø–æ–∫–∞–∑–∞–Ω–∏—è, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, —Ä–∏—Å–∫–∏, –∑–∞–º–µ–Ω—ã
5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —á—Ç–æ, –∫–∞–∫ —á–∞—Å—Ç–æ, —Å –∫–∞–∫–æ–π —Ü–µ–ª—å—é
6. –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –≥–∞–π–¥–ª–∞–π–Ω—ã, PubMed/UpToDate/DOI
üíä –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ê–≥–µ–Ω—Ç–∞ –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏:

–°—Ç—Ä–æ–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–π –Ω–æ–∑–æ–ª–æ–≥–∏–∏: –æ—Å–Ω–æ–≤–Ω–æ–π, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–µ–π, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π
–î–∞–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å –¥–æ–∑–∞–º–∏, —Ñ–æ—Ä–º–æ–π, —Ä–µ–∂–∏–º–æ–º –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
–£–∫–∞–∑—ã–≤–∞—Ç—å:
–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–ú–ù–ù)
–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏)
–î–æ–∑–∏—Ä–æ–≤–∫—É: –º–≥, –º–≥/–º¬≤, –º–≥/–∫–≥ ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü—É—Ç—å –≤–≤–µ–¥–µ–Ω–∏—è (–≤/–≤, –≤–Ω—É—Ç—Ä—å –∏ —Ç.–¥.)
–ö—É—Ä—Å: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –∑–∞—á–µ–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è, —á–µ–º –∑–∞–º–µ–Ω–∏—Ç—å, —Ä–∏—Å–∫–∏, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è
–î–µ–ª–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É:
–≠—Ç–∏–æ—Ç—Ä–æ–ø–Ω–æ–π —Ç–µ—Ä–∞–ø–∏–µ–π
–°–∏–º–ø—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π
–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–π
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π
üìå –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

–ñ–∞–ª–æ–±—ã: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–æ 39, –∫–∞—à–µ–ª—å —Å –º–æ–∫—Ä–æ—Ç–æ–π, –æ–∑–Ω–æ–±, –æ–¥—ã—à–∫–∞. B-NHL, –ü–•–¢, –ª–∏–º—Ñ–æ–ø–µ–Ω–∏—è. –≠—Ö–æ–ö–ì ‚Äî –≥–∏–¥—Ä–æ–ø–µ—Ä–∏–∫–∞—Ä–¥.
–°—Ñ–æ—Ä–º–∏—Ä—É–π —Ç–æ—á–Ω—É—é –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É –ø–æ –≤—Å–µ–º –Ω–æ–∑–æ–ª–æ–≥–∏—è–º —Å –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏, –¥–æ–∑–∞–º–∏, –∫—É—Ä—Å–∞–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É.
üí¨ –¢–µ–ø–µ—Ä—å –∞–≥–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ ‚Äú–∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π‚Äù, –±–µ–∑ –≤–æ–¥—ã –∏ —Å –ø–æ–ª–Ω–æ–π —Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π.
"""

# üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
st.set_page_config(page_title="üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", page_icon="üß†")
st.title("üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç")
st.markdown("AI —á–µ—Ä–µ–∑ OpenRouter GPT-4o. –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç.")

# üí¨ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]

# üîÑ –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
if st.button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥"):
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]
    st.rerun()

# üî¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
for msg in st.session_state.messages[1:]:
    role = "üë§ –í—Ä–∞—á" if msg["role"] == "user" else "üß† –í–ú–ö"
    st.markdown(f"**{role}:** {msg['content']}")

# üñäÔ∏è –í–≤–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
question = st.text_area("‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:")

# üì® –û—Ç–ø—Ä–∞–≤–∫–∞
if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å") and question:
    st.session_state.messages.append({"role": "user", "content": question})
    with st.spinner("üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞..."):
        try:
            response = requests.post(
                API_URL,
                headers={
                    "Authorization": f"Bearer {OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                    "Referer": "https://medical-consultant-app.streamlit.app",
                    "X-Title": "medical-consultant-app"
                },
                json={
                    "model": MODEL,
                    "messages": st.session_state.messages,
                    "temperature": 0.3
                }
            )

            if response.status_code == 200:
                result = response.json()
                reply = result["choices"][0]["message"]["content"]
                st.session_state.messages.append({"role": "assistant", "content": reply})
                st.rerun()
            else:
                st.error(f"OpenRouter –æ—à–∏–±–∫–∞: {response.status_code}")
                st.json(response.json())
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")