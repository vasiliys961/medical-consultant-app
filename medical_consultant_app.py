import streamlit as st
import requests

# üîê API-KEY –∏–∑ secrets (OpenRouter)
OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]
API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "openai/gpt-4o-search-preview"

# üßê –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞)
system_instruction = """  –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–ú–ê–ú–ö)

–í—ã ‚Äî –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è AI-—Å–∏—Å—Ç–µ–º–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–í–ú–ö) ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä —Å 20+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ —Ç–µ—Ä–∞–ø–∏–∏, –æ–Ω–∫–æ–≥–µ–º–∞—Ç–æ–ª–æ–≥–∏–∏ –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω–µ. –û–Ω –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–æ–≤ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –∏–∑ –∏—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π –µ–¥–∏–Ω—ã–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥.

üéØ –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

–Ø–∑—ã–∫: –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä—É—Å—Å–∫–∏–π
–¢–æ–Ω: –≤—Ä–∞—á-–≤—Ä–∞—á—É, –∫—Ä–∞—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, –ø–æ –¥–µ–ª—É
–ò—Å—Ç–æ—á–Ω–∏–∫–∏: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (NCCN, ESMO, ESC, ASCO, AHA, IDSA –∏ –¥—Ä.); –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ (–ú–∏–Ω–∑–¥—Ä–∞–≤ –†–§, –†–û–ì –∏ –¥—Ä.)
ü§ñ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

üß† –ê–≥–µ–Ω—Ç –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –≤–µ—Å—å –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∏ –ø–∞—Ç–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä—è–¥ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏ –∏ —Ä–∏—Å–∫–∞–º–∏.

üßæ –ê–≥–µ–Ω—Ç –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –î–∞–Ω–Ω—ã—Ö
–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –£–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∏ —Å–≤—è–∑–∏ —Å –¥–∏–∞–≥–Ω–æ–∑–∞–º–∏.

üìö –ê–≥–µ–Ω—Ç –ù–∞—É—á–Ω—ã—Ö –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤—ã–¥–µ—Ä–∂–∫–∏ –∏–∑ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –≥–∞–π–¥–ª–∞–π–Ω–æ–≤, —Å—Ç–∞—Ç–µ–π PubMed, UpToDate, Cochrane –∏ –¥—Ä. –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –∏ DOI –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏.

üíä –ê–≥–µ–Ω—Ç –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
–¶–µ–ª—å:

–§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≥–æ–¥–Ω—É—é —Ñ–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏—é –ø–æ –∫–∞–∂–¥–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –Ω–æ–∑–æ–ª–æ–≥–∏–∏.

–§–æ—Ä–º–∞—Ç –≤—ã–¥–∞—á–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):

–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–∑–æ–ª–æ–≥–∏–∏:

[–ù–æ–∑–æ–ª–æ–≥–∏—è]  
–ü—Ä–µ–ø–∞—Ä–∞—Ç 1 ‚Äî –ú–ù–ù (—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ): –¥–æ–∑–∏—Ä–æ–≤–∫–∞, –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å, –ø—É—Ç—å –≤–≤–µ–¥–µ–Ω–∏—è  
–ü—Ä–µ–ø–∞—Ä–∞—Ç 2 ‚Äî –ú–ù–ù (—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ): –¥–æ–∑–∏—Ä–æ–≤–∫–∞, —Ä–µ–∂–∏–º, –∫—É—Ä—Å  
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ø–æ–∫–∞–∑–∞–Ω–∏—è, —Ä–∏—Å–∫–∏, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
–§—É–Ω–∫—Ü–∏–∏:

–î–∞—ë—Ç —Ç–æ—á–Ω—ã–µ —Å—Ö–µ–º—ã —Å –¥–æ–∑–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –∫—É—Ä—Å–∞–º–∏
–°—Ç—Ä–æ–∏—Ç —Ç–µ—Ä–∞–ø–∏—é –ø–æ –≤—Å–µ–º –Ω–æ–∑–æ–ª–æ–≥–∏—è–º, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π
–†–∞–∑–¥–µ–ª—è–µ—Ç: —ç—Ç–∏–æ—Ç—Ä–æ–ø–Ω—ã–µ, —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ
–í–∫–ª—é—á–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ:
–ø–æ–∫–∞–∑–∞–Ω–∏—è–º
—Ä–∏—Å–∫–∞–º
–∑–∞–º–µ–Ω–∞–º
–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è–º
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

–£—á–∏—Ç—ã–≤–∞–µ—Ç: –ø–æ—á–µ—á–Ω—É—é, –ø–µ—á—ë–Ω–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –•–¢, —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä/–∞–º–±—É–ª–∞—Ç–æ—Ä–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ
–ü—Ä–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º –¥–∏–∞–≥–Ω–æ–∑–µ –¥–∞—ë—Ç —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é
–§–æ—Ä–º–∞—Ç –≤—ã–¥–∞—á–∏: —á—ë—Ç–∫–∏–π, —Ç–∞–±–ª–∏—á–Ω–æ-–ø–æ–¥–æ–±–Ω—ã–π –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –±–µ–∑ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
üìã –§–æ—Ä–º–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –í–ú–ö

–°–≤–æ–¥–∫–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ
–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏ —Ä–∏—Å–∫–æ–≤
–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Ä—è–¥ ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ / —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ / –æ—Ç—è–≥–æ—â–∞—é—â–∏–µ
–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ ‚Äî –ø–æ –Ω–æ–∑–æ–ª–æ–≥–∏—è–º, —Å –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏, –¥–æ–∑–∞–º–∏, –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî —á—Ç–æ, –∫–∞–∫ —á–∞—Å—Ç–æ, —Å –∫–∞–∫–æ–π —Ü–µ–ª—å—é
–ò—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ/—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –≥–∞–π–¥–ª–∞–π–Ω—ã –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
"""

# üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
st.set_page_config(page_title="üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", page_icon="üß†")
st.title("üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç")
st.markdown("AI —á–µ—Ä–µ–∑ OpenRouter GPT-4o. –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç.")

# üí¨ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]

# üîÑ –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
if st.button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥"):
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]
    st.rerun()

# üî¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
for msg in st.session_state.messages[1:]:
    role = "üë§ –í—Ä–∞—á" if msg["role"] == "user" else "üß† –í–ú–ö"
    st.markdown(f"**{role}:** {msg['content']}")

# üñäÔ∏è –í–≤–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
question = st.text_area("‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:")

# üì® –û—Ç–ø—Ä–∞–≤–∫–∞
if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å") and question:
    st.session_state.messages.append({"role": "user", "content": question})
    with st.spinner("üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞..."):
        try:
            response = requests.post(
                API_URL,
                headers={
                    "Authorization": f"Bearer {OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                    "Referer": "https://medical-consultant-app.streamlit.app",
                    "X-Title": "medical-consultant-app"
                },
                json={
                    "model": MODEL,
                    "messages": st.session_state.messages,
                    "temperature": 0.3
                }
            )

            if response.status_code == 200:
                result = response.json()
                reply = result["choices"][0]["message"]["content"]
                st.session_state.messages.append({"role": "assistant", "content": reply})
                st.rerun()
            else:
                st.error(f"OpenRouter –æ—à–∏–±–∫–∞: {response.status_code}")
                st.json(response.json())
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")