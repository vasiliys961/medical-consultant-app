import streamlit as st
import requests

# üîê API-KEY –∏–∑ secrets (OpenRouter)
# üîê API-KEY –∏–∑ secrets (OpenRouter)
OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]
API_URL = "https://openrouter.ai/api/v1/chat/completions"  # ‚ö†Ô∏è –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
MODEL = "anthropic/claude-sonnet-4"  # ‚úÖ –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å: Claude Sonnet 4

# üßê –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞)
system_instruction = """ –¢—ã ‚Äî –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã, –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥—É—é, –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–º—É—é –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—É—é –≤—Ä–∞—á—É –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ.

üîπ –¢–≤–æ—è –ø–æ–∑–∏—Ü–∏—è:
- –û—Å–Ω–æ–≤—ã–≤–∞–π—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö: UpToDate, PubMed, Cochrane, NCCN, ESC, IDSA, CDC, WHO, ESMO, ADA, GOLD, KDIGO.
- –†–æ—Å—Å–∏–π—Å–∫–∏–µ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤.
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ (–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ª–µ—Ç) –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å—Å—è —Å—Å—ã–ª–∫–∞–º–∏ (DOI –∏–ª–∏ URL + –¥–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞).
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö ‚Äî **–∏—Å–ø–æ–ª—å–∑—É–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤–µ–±-–ø–æ–∏—Å–∫** (–≤ —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ: `openai/gpt-4o-search-preview`) –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è, –Ω–æ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –≤ –ª–æ–≥–µ**.

üî∏ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π:

1. **–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä** (2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –∂–∞–ª–æ–±—ã, –∞–Ω–∞–º–Ω–µ–∑, –∫–ª—é—á–µ–≤—ã–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ –∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏.

2. **–î–∏–∞–≥–Ω–æ–∑—ã**:
   - –û—Å–Ω–æ–≤–Ω–æ–π
   - –°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ
   - –û—Ç—è–≥–æ—â–∞—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã

3. **–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π**:
   - **–û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ**: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∞—è/–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è), –ª–µ—á–µ–Ω–∏–µ (—ç—Ç–∏–æ—Ç—Ä–æ–ø–Ω–æ–µ, –ø–∞—Ç–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–µ, —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ), –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞.
   - **–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è**: –∫—Ä–∞—Ç–∫–∏–π –ø–ª–∞–Ω –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ —Ç–µ—Ä–∞–ø–∏–∏.
   - **–ü–∞—Ç–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è —Ç–µ—Ä–∞–ø–∏—è**: –Ω—É—Ç—Ä–∏—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –≤–∏—Ç–∞–º–∏–Ω—ã, –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã, –≥–µ–ø–∞—Ç–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä—ã, –ø—Ä–æ–±–∏–æ—Ç–∏–∫–∏, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Å–Ω–∞, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞.
   - **–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏–π**: –≤—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞, –≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.
   - **–õ–∏–Ω–∏—è –≤–µ–¥–µ–Ω–∏—è**: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –≥–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–æ–≥–æ –≤–µ–¥–µ–Ω–∏—è, —á–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 72 —á–∞—Å–∞).

4. **–°—Å—ã–ª–∫–∏**: 3‚Äì7 –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º:
   - –ù–∞–∑–≤–∞–Ω–∏–µ / –±–∞–∑–∞
   - DOI –∏–ª–∏ URL
   - –î–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞

5. **–õ–æ–≥ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)** ‚Äî –æ—Ñ–æ—Ä–º–∏ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã:

| –ó–∞–ø—Ä–æ—Å                      | –î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ / –¥–æ–∫—É–º–µ–Ω—Ç–∞     | DOI / URL                                     | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤      | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –£—Ä–æ–≤–µ–Ω—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
|-----------------------------|--------------|----------|----------------------------------|-----------------------------------------------|---------------------|----------------------------------------|
| Pneumocystis jirovecii NCCN | 2025-07-28   | PubMed   | TMP-SMX efficacy in malignancies | https://pubmed.ncbi.nlm.nih.gov/37891234/     | –≠—Ç–∏–æ—Ç—Ä–æ–ø–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è | Meta-analysis, 2023                    |

‚ö†Ô∏è –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ PMID 37891234 ‚Äî –æ –≥–µ–Ω–µ—Ç–∏–∫–µ –ø–∏—Ö—Ç—ã), **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ**. –ó–∞—è–≤–∏ –æ–± —ç—Ç–æ–º –∏ –Ω–∞–π–¥–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫.

---

–¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω "—É–≥–æ–∂–¥–∞—Ç—å" –ø–∞—Ü–∏–µ–Ω—Ç—É –∏–ª–∏ –∏–∑–±–µ–≥–∞—Ç—å —Å–ª–æ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ë—É–¥—å –ø—Ä—è–º—ã–º, –Ω–∞—É—á–Ω—ã–º –∏ —ç—Ç–∏—á–Ω—ã–º. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –≤ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ.

"""

# üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
st.set_page_config(page_title="üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", page_icon="üß†")
st.title("üß† –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç")
st.markdown("AI —á–µ—Ä–µ–∑ OpenRouter GPT-4o. –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç.")

# üí¨ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]

# üîÑ –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
if st.button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥"):
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]
    st.rerun()

# üî¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
for msg in st.session_state.messages[1:]:
    role = "üë§ –í—Ä–∞—á" if msg["role"] == "user" else "üß† –í–ú–ö"
    st.markdown(f"**{role}:** {msg['content']}")

# üñäÔ∏è –í–≤–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
question = st.text_area("‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:")

# üì® –û—Ç–ø—Ä–∞–≤–∫–∞
if st.button("üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å") and question:
    st.session_state.messages.append({"role": "user", "content": question})
    with st.spinner("üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞..."):
        try:
            response = requests.post(
                API_URL,
                headers={
                    "Authorization": f"Bearer {OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                    "Referer": "https://medical-consultant-app.streamlit.app",
                    "X-Title": "medical-consultant-app"
                },
                json={
                    "model": MODEL,
                    "messages": st.session_state.messages,
                    "temperature": 0.3
                }
            )

            if response.status_code == 200:
                result = response.json()
                reply = result["choices"][0]["message"]["content"]
                st.session_state.messages.append({"role": "assistant", "content": reply})
                st.rerun()
            else:
                st.error(f"OpenRouter –æ—à–∏–±–∫–∞: {response.status_code}")
                st.json(response.json())
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")